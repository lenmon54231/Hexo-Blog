---
title: 服务器使用和配置
date: 2025-09-16 11:51:19
tags: [server,node,服务器]
---

# 服务器使用和配置

之前已经实现了利用node实现前端代码更新和部署，现在要实现后端代码和部署，因为后端代码不需要打包，所以准备采用WebHook的形式来更新部署，后续还会有更多的功能陆续实现。

<!-- more -->

## 服务器后端Node代码自动更新

### 目标

只需要本地提交代码，自动更新服务器上的Node后端代码

### 实现

通过GitHub的Deploy+宝塔WebHook可以轻松实现上述目标

#### 首先去GitHub添加Deploy keys

```shell
# 1. 切换到 www 用户
sudo -u www bash
# 2. 生成新钥匙（若已有可跳过）
ssh-keygen -t ed25519 -C "www-webhook" -N "" -f ~/.ssh/id_ed25519
# 3. 把公钥加到 GitHub Deploy keys
cat ~/.ssh/id_ed25519.pub
```

进入对应的仓库，然后在setting里找到Deploy keys菜单，将cat输出的公钥添加到Deploy keys中即可

#### 然后去宝塔中添加WebHook

1. 安装“宝塔WebHook”
 
2. 打开WebHook，并添加Hook

名称可以用：node-deploy

执行脚本如下：
```
#!/bin/bash
cd /www/wwwroot/api
whoami
sudo -u www git fetch --depth=1
sudo -u www git reset --hard origin/main
sudo -u www npm ci --omit=dev
sudo -u www pm2 reload app --update-env || \
sudo -u www pm2 start server.js --name app --env production --update-env
echo "-----------------------done-----------------------"
```

这里使用的是www用户，根据AI的说法，使用root用户来执行WebHook是有注入风险的

以上脚本推荐先由自己手动链接上服务器操作一次，中间可能会遇到很多提示，需要用户手动操作，比如：

```shell
[www@VM-4-3-opencloudos api]$ git remote -v
fatal: detected dubious ownership in repository at '/www/wwwroot/api'
To add an exception for this directory, call:

        git config --global --add safe.directory /www/wwwroot/api
```

这里就会有权限问题，需要手动操作一次，后续才能正常执行git

```shell
# 退出 www 用户
exit
# 用刚才能 sudo 的账号执行
sudo chown -R www:www /www/wwwroot/api
```

## ffmpeg 处理视频功能

本次是因为更新 ffmpeg 处理视频功能，上传 server 后，引入的 fluent-ffmpeg 没有在 centOS 中安装。需要安装后再启动 node

1. [官网下载 linux 版本的 ffmpeg 源码包 ffmpeg-4.1.tar.xz](https://johnvansickle.com/ffmpeg/release-source/)

2. 使用 xftp 将源码包 ffmpeg-4.1.tar.xz 上传至 linux 主机，解压源码包

   ```js
   cd /usr/local/
   mkdir ffmpeg    #在usr/local目录下创建ffmpeg目录
   cd /usr/local/ffmpeg
   tar xvJf ffmpeg-4.1.tar.xz
   cd ffmpeg-4.1
   yum install gcc
   yum install yasm
   ./configure --enable-shared --prefix=/usr/local/ffmpeg
   make
   make install
   ```

3. 编译完成后，需要修改 path

   ```js
   vim / etc / ld.so.conf;
   ```

   ```js
   内容如下：
   include ld.so.conf.d/*.conf
   /usr/local/ffmpeg/lib/
   ```

   输入**ldconfig**使修改生效。

   ```js
   ldconfig;
   ```

4. 查看版本

   ```JS
   /usr/local/ffmpeg/ffmpeg-4.1/ffmpeg -version
   ```

5. 配置环境变量

   ```JS
   # vim /etc/profile
   ```

   ```js
   内容如下：
   #set ffmpeg environment
   PATH=$PATH:/usr/local/ffmpeg/bin
   export PATH
   ```

   ```js
   source /etc/profile #使配置生效
   ```

   ```js
   ffmpeg - version;
   ```

   最终展示如下：可以在任意地方使用 ffmpeg

   ![img](https://img2018.cnblogs.com/blog/1486162/201907/1486162-20190710113208809-336235091.png)

 

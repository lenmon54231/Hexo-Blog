---
title: 淘宝小程序记录
date: 2023-09-28 16:27:11
tags: [tb]
---

## 淘宝小程序记录

### 淘宝小程序无样式隔离

淘宝小程序默认组件间样式无隔离

[组件样式无隔离](https://opendocs.alipay.com/mini/framework/page-acss)

在支付宝文档中，有说明如果需要隔离，需添加

```js
{
  "styleIsolation": "apply-shared"
}
```

### 需使用老版 Canvas

新版 canvas 有各种问题，无法使用。新老版本差异可以参考如下：

[新老版本 canvas](https://opendocs.alipay.com/mini/055eid?pathHash=0b1d0dfc)

#### 老版 canvas 使用

```html
<canvas id="my-canvas"></canvas>
```

```js
Page({
  onLoad() {
    const context = my.createCanvasContext("my-canvas");
  },
  drawPoster() {
    const src =
      "https://img.alicdn.com/tfs/TB1GvVMj2BNTKJjy0FdXXcPpVXa-520-280.jpg";
    context.drawImage(src, 0, 0, 250, 80);
    ctx.draw(false, () => {
      ctx.toTempFilePath({
        x: 0,
        y: 0,
        width: 250,
        height: 80,
        fileType: "jpg",
        quality: 1,
        success(res) {
          console.log(res);
        },
      });
    });
  },
});
```

#### 解决 Canvas 画布模糊

```html
<canvas
  id="poster_canvas"
  width="{{canvasWidthWithDPR}}"
  height="{{canvasHeightWithDPR}}"
  style="{{ style }}"
>
</canvas>
```

```js
Component({
  data: {
    style: "",
    canvasWidthWithDPR: 375,
    canvasHeightWithDPR: 684,
    canvasOriginWidth: 375,
    canvasOriginHeight: 684,
  },
  didMount() {
    // 动态设置canvas的宽高：https://opendocs.alipay.com/support/01rb8t?ant_source=opendoc_recommend
    let { pixelRatio } = getSystemInfoSync();
    const style = `width: ${this.data.canvasOriginWidth}px; height: ${this.data.canvasOriginHeight}px; position: fixed; left: 0%; top: 0%;`;
    this.setData({
      style,
      canvasWidthWithDPR: this.data.canvasOriginWidth * pixelRatio,
      canvasHeightWithDPR: this.data.canvasOriginHeight * pixelRatio,
    });
  },
});
```

#### 控制 Canvas 生成的图片质量和大小

canvas 的生成图片比例由两个地方决定：

1. drawImage 决定从初始图片上裁剪的位置和宽高比例
2. toTempFilePath 决定输出图片的宽高

```js
const context = my.createCanvasContext("photo_canvas");

let { windowWidth, windowHeight, pixelRatio } = getSystemInfoSync();

let cutImageWithDPR = await getCompressedImg(
  photoUrl,
  context,
  windowWidth,
  windowHeight,
  pixelRatio
);

function getCompressedImg(imgUrl, context, canvasWidth, canvasHeight, dpr) {
  return new Promise((resolve) => {
    getImageInfo(imgUrl).then((image) => {
      const { width, height } = image;
      let widthScale = canvasWidth / width;
      let heightScale = canvasHeight / height;
      let drawImageHeight = null;
      let drawImageWidth = null;
      let dx = null;
      let dy = null;
      if (widthScale < heightScale) {
        drawImageHeight = canvasHeight;
        drawImageWidth = width * heightScale;
        dx = -(drawImageWidth - canvasWidth) / 2;
        dy = -(drawImageHeight - canvasHeight) / 2;
      } else {
        drawImageWidth = canvasWidth;
        drawImageHeight = height * widthScale;
        dx = -(drawImageWidth - canvasWidth) / 2;
        dy = -(drawImageHeight - canvasHeight) / 2;
      }

      context.drawImage(
        imgUrl,
        dx * dpr,
        dy * dpr,
        drawImageWidth * dpr,
        drawImageHeight * dpr
      );

      context.draw(false, async () => {
        const tempFilePath = await canvasToTempFilePathByCanvasApi(
          context,
          canvasWidth * dpr,
          canvasHeight * dpr
        );
        resolve(tempFilePath);
      });
    });
  });
}

function canvasToTempFilePathByCanvasApi(context, width, height) {
  return new Promise((resolve, reject) => {
    context.toTempFilePath({
      fileType: "jpg",
      x: 0,
      y: 0,
      width,
      height,
      quality: 1,
      destWidth: width,
      destHeight: height,
      success(res) {
        // resolve(res.tempFilePath);
        resolve(res.apFilePath);
      },
      fail(err) {
        reject(err);
      },
    });
  });
}
```

假定传入图片的宽高为：720*1280，canvas 输出的图片宽高为屏幕宽高：390*844

1. 首先分别计算宽高的缩放比例，得到最终需要缩放的是图片宽度
2. 然后计算出缩放后的图片宽度和距离左上角的 dx 。此时 dy 为 0，高度为 844
3. 通过 toTempFilePath 输出 390\*844 的图片
